<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   logicalFilePath="lon-service-mpd/gin/15.100/15.100.0.0.changelog.xml"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="20240728-11" author="ilya">
        <createView replaceIfExists="true" viewName="bills_view">
            SELECT b.id,
                   b.mentioned_date,
                   b.buyer,
                   b.seller,
                   b.amount,
                   b.currency,
                   b.purpose,
                   string_agg(t.name, ',') AS tags,
                   g.owner_id
            FROM bills b
                     LEFT JOIN
                 public.bills_to_tags btt ON b.id = btt.bill_id
                     LEFT JOIN
                 public.bill_tags t ON btt.tag_id = t.id
                     JOIN
                 groups g ON b.group_id = g.id
            WHERE b.state = 'ACTIVE'
              AND b.status = 'CONFIRMED'
            GROUP BY b.id, g.owner_id;
        </createView>
    </changeSet>
</databaseChangeLog>